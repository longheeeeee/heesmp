1. 项目背景
2. 项目需求
3. 项目工作
4. 项目复盘
5. 项目优化

# 1. 项目背景
### 业务上
1. oa、crm、cms三个系统的账号系统不一致，用户需要分开登录
### 技术上
1. 工程增大，项目启动慢
2. 同一个项目分支增多，管理混乱
3. 重构成本增加，开发人员难以应用新技术

# 2. 项目需求
针对第一个权限系统的统一，需要做的事情有：
1. 账号数据的统一
2. 权限数据的统一
3. 鉴权方法的统一

针对第二个问题，可以使用微前端解决，需要做的事情有：
1. 菜单数据需要统一
2. 各个子应用需要做修改来接入

所以说，最终的需求分成：
1. 账号数据
2. 权限数据，包括菜单
3. 鉴权方法
4. 接入微前端

# 3. 项目工作
## 3.1 账号数据的统一
直接统一三个系统的数据会造成大量的改动，所以最终的解决方法是对三个系统做一层关联，主要使用oa的账号。
1. 原有的用户数据，使用oa账号的手机号查询其他系统的对应账号并且做关联
2. 新用户注册的时候，先注册oa的账号，然后再登录crm、cms进行额外信息的填写，然后crm、cms根据用户的token请求oa的账号密码信息，直接复制到自己的数据库里
3. 当oa账号发生改动的时候，同步到crm、cms系统更新数据库

## 3.2 权限数据的统一
1. oa新增角色管理、菜单管理、接口管理三个管理页面
2. crm和cms的菜单数据和角色数据手动复制（或者使用sql复制）到oa的菜单管理和角色管理
3. 数据权限因为差别太大，没有做迁移

## 3.3 鉴权方式的统一
1. crm、cms后端接入网关，统一使用网关鉴权
2. 菜单接口替换成oa的菜单接口

## 3.4 接入微前端
接入微前端，实际上需要完成下面的事情
1. 改动子应用的代码，暴露生命周期方法
2. 子应用打包方法修改成umd
3. 子应用路由添加前缀，并且修改publicPath
4. 子应用nginx添加跨域头
5. 子应用菜单数据需要整理后复制到微前端菜单数据
6. 编写主应用，包括子应用的挂载，还有用户信息，菜单

对于上面的需求来说，我们首先尝试修改oa来接入微前端，然后在修改oa的过程中沉淀出一些工具方法，并且把这些工具方法应用到直播系统上
#### 1. 把生命周期方法的暴露逻辑封装成一个组件
##### 目的：
为了减少接入人员对于qiankun的多余学习成本，我们封装了一个组件来抹平一些子应用单独运行和接入到微前端运行的差异
##### 实现：
1. 把生命周期方法的暴露逻辑封装成一个组件，然后暴露一些默认的生命周期方法给qiankun使用，子应用使用另外暴露的一个register方法来接入
2. register方法接收一个方法，这个方法传入一个prop的参数，props传入了主应用传递给子应用的信息，包括子应用当前的一些应用信息，还有主应用传递给子应用的用户信息，菜单按钮权限，主应用暴露给子应用的数据和修改方法等
3. 子应用在这个方法进行初始化，包括new Vue和初始化一些比如路由权限等数据，最后返回一个destory的方法来卸载
4. 在子应用单独执行的时候，组件会根据当前环境主动调用register方法，并且单独获取用户信息、权限信息等，包装成props返回给子应用

#### 2. 封装了一个刷新token的插件
##### 目的：
因为子应用原本使用的token跟oa的token不一样，也没有刷新机制，如果每个子应用都进行更改的话太麻烦，也不利于后面子应用的接入，所以我决定在主应用的项目里面对全局的http请求做拦截，添加一层token校验，来减少对子应用的侵入性
##### 原理：
- 组件使用了ajsx-hook这个开源库，原理大概是重写了XmlHttpRequest，在初始化的时候可以传入一些和XHR里面重名的方法，然后在使用XHR发起请求的时候和请求返回触发回调的时候，会先查询有没有传入拦截的方法，比如open、onReadyStateChange等，先执行拦截方法再执行原生方法
##### 实现：
- 主要功能是两个部分，一个是添加请求头，一个是自动刷新token
- 实现原理是，组件内部维护了一个队列，然后在发起请求的时候，会把请求放到队列里面，然后判断请求有没有带上token，没有的话加上，然后请求返回的时候把队列里面对应的请求删掉。然后当请求返回302的时候，把队列锁住，新进来的请求不允许发出，同时发起请求刷新token，刷新完成后，替换掉队列里面请求的token，打开队列锁重新发送请求
##### 优缺点：
- 优点是减少接入人员的接入成本，对子应用没有侵入性，缺点是如果出了bug排查起来会比较麻烦

#### 3. 写了一个chrome插件帮助开发
##### 目的：
为了方便子应用开发人员后续的开发和调试，开发了一个chrome插件来提供快捷登录和调试的功能
##### 功能：
1. 因为开发人员需要经常登录统一平台再跳转，特别是要经常多环境（开发测试），多账号，多目标页面（本地、线上）进行跳转，所以添加了一个功能快速登录和跳转，根据环境来保存用户的账号密码和目标页面，并且支持保存token，这样子就不需要来回跳转了
2. 因为子应用只在本地运行，所以如果想要在开发测试环境调试一些应用间传递消息的功能就不好处理了，所以也提供了在开发测试环境下主应用拉取本地子应用地址进行调试的功能。主要实现原理是插件先获取到子应用列表，然后用户可以手动修改应用列表里面的地址，然后保存到localStorage，主应用在拉取列表之前会优先使用localStorage里面的列表

#### 4. 迁移子应用菜单权限到主应用菜单
##### 需求：
因为子应用菜单跟主应用菜单并不是一一对应，所以需要根据产品文档来迁移子应用的菜单，并且迁移完菜单后还需要关联原来菜单的角色和接口关系
##### 实现：
1. 产品需要整理旧菜单和新菜单的关系
2. 使用nodejs脚本来生成sql文件，其中需要生成的逻辑有：
    1. 数据备份
    2. 更新oa和直播系统的所有菜单，添加上/oa或者/live-admin前缀
    3. 生成并插入一级菜单
    4. 插入非一级菜单，根据上一步生成的一级菜单，根据菜单名称查pid
    5. 查出旧菜单对应的所有角色，生成跟新菜单的对应关系
    6. 查处旧菜单对应的所有接口，生成跟新菜单的对应关系

#### 5. 开发脚手架和沉淀模版







