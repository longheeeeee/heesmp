# 1. DNS
dns，（domain name system域名服务器），根据域名查询到对应服务器的ip

# 2. 流程
1. 查询浏览器缓存
2. 查询本地DNS解析器，解析器查询缓存
3. 解析器查询本地域名服务器，本地域名服务器查询其缓存
4. 本地域名服务器迭代查询根域名服务器(.)、顶级域名服务器(com)、二级域名服务器(google)等
5. 获取到dns上的域名记录，如果域名是address记录，则直接返回给用户的本地DNS解析器
6. 如果是Cname记录，则再次向对应域名服务器查询，再返回给用户
7. 总结就是：浏览器-系统-本地域名-迭代查询

# 3. CDN
### 定义：
CDN，内容分发网络，由遍布全国的高性能节点组成，高性能节点会按照一定缓存策略存储服务器内容，用户在发起请求的时候，会被调度到最接近用户的节点，服务节点直接响应，降低用户访问延迟
### 作用：
- 缩短用户因地理位置造成的访问延迟，缓解服务器带宽压力
### 原理：
1. 用户向本地dns服务器发起dns解析请求
2. 本地dns服务器去查找权威dns服务器，权威dns服务器返回的是cname记录，指向cdn服务器
3. cdn服务器根据本地服务器的ip地址返回距离最近的cdn节点ip地址
4. 本地服务器获取到ip记录后缓存起来并且返回给用户
5. 用户请求就会被转向cdn节点而不是源服务器
6. 当用户的请求缓存失效或者没有命中，cdn服务器就会逐层往上发起请求，直到回源
### 302调度
#### 传统CDN请求缺点：
1. 根据本地dns服务器地址查询，不是按照用户ip地址查询
2. 本地dns服务器返回固定节点，不能灵活变动，不能按照当前各地方节点状态切换节点
#### 302调度原理
1. 用户向本地dns服务器发起dns解析请求
2. 本地dns服务器去查找权威dns服务器，权威dns服务器返回cname记录，指向cdn服务器
3. cdn服务器返回a记录，指向cdn调度服务器
4. 本地dns服务器返回cdn调度服务器地址给用户
5. 用户向cdn调度服务器发起请求
6. cdn调度服务器根据用户ip地址，节点状态等信息，把请求302到最合适的节点
7. cdn节点响应内容
#### 302调度不足
1. 调度服务器出问题用户请求就会失效
2. 多了一次响应时间
3. 判断调度策略需要消耗成本
### 预热
用户第一次请求服务器因为需要回源所以时间会很长，为了解决这个问题，cdn服务器可以使用预热服务器向节点群发请求来使节点缓存文件，防止新活动上线源站带宽不足直接崩溃
### 刷新
使用刷新服务器删除或者过期cdn节点的缓存，然后令节点回源重新请求文件并缓存
### CDN劫持
cdn劫持分成两种：
#### DNS劫持（域名劫持）
为了减少网间结算（当地ISP和其他地方ISP之间流量计费），ISP把部分资源缓存到自己的节点上，本地dns解析器返回运营商的节点，导致资源不是最新的。
- 解决方法：使用httpdns，调用httpdns服务提供商的ip地址然后带上域名，然后返回对应的IP地址，直接使用ip地址发起请求，就可以绕过本地dns服务器

#### HTTP劫持
1. 302劫持：cdn返回200和资源，中间节点修改成302导致用户访问到其他内容
2. 内容劫持：cdn返回200和资源，中间节点修改文件内容，如插入iframe等
- 解决方案：使用全站https，添加md5校验等
  
### 提高命中率
1. 添加合适的缓存头，比如cache-control不要使用no-cache，no-store等
2. 配置合适的请求缓存时间
3. 新活动上线前预热
4. 请求量小的资源会被LRU算法删除
5. 去参数缓存

### cdn速度慢排查
1. 考虑是否经常回源
2. 源站性能
3. 缓存策略设置有误
4. 海外国内跨地区访问

